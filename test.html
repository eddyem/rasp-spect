<html>
<head>
	<meta charset=koi8-r http-equiv="Content-Language" content="ru"/>
	<title>A test</title>
	<style type="text/css">
	.content { vertical-align:top; text-align:center; background:#fffff0; padding:12px; border-radius:10px; }
	button { display: block; width: 70px; text-align: center; }
	.container {border: solid 1px;  border-radius:10px; padding:12px; }
</style>
<script>
Global = function(){
	var socket = null;
	var imsocket = null;
	var connected = 0;
	var globSpeed = 0;
	function $(nm){return document.getElementById(nm);}
	function get_appropriate_ws_url(){
		var pcol;
		var u = document.URL;
		if (u.substring(0, 5) == "https") {
			pcol = "wss://";
			u = u.substr(8);
		} else {
			pcol = "ws://";
			if (u.substring(0, 4) == "http")
				u = u.substr(7);
		}
		u = u.split('/');
		return pcol + u[0] + ":9999";
	}
	function send(){
		imsocket.send("get");
	}
	var frames = 0, time = 0;
	function getcntr(){
		time++;
		if(connected)
			$("cntr").innerHTML = frames/time;
		setTimeout(getcntr, 1000);
	}
//	function hexToBase64(str) {
//		return btoa(String.fromCharCode.apply(null, str.replace(/\r|\n/g, "").replace(/([\da-fA-F]{2}) ?/g, "0x$1 ").replace(/ +$/, "").split(" ")));
//	}
//	function base64encode(binary) {
//		return btoa(unescape(encodeURIComponent(binary)));
//	}
	var wdTmout;
	function TryImsock(){
		console.log("Try to connect to image socket");
		if(imsocket){
			imsocket.onclose = function(){};
			imsocket.close();
			delete imsocket;
		}
		apprURL = get_appropriate_ws_url();
		if (typeof MozWebSocket != "undefined") {
			imsocket = new MozWebSocket(apprURL,
						"image-protocol");
		} else {
			imsocket = new WebSocket(apprURL,
						"image-protocol");
		}
		try {
			imsocket.onopen = function(){
				frames = 0; time = 0;
				setTimeout(getcntr, 1000);
				send();
			}
			imsocket.onmessage = function(msg){
				var img = $("ws_image");
				img.src = "data:image/jpeg;base64," + msg.data;
				frames++;
				clearTimeout(wdTmout);
				wdTmout = setTimeout(TryImsock, 3000);
				setTimeout(send, 50);
			}
			imsocket.onclose = function(){
				$("connected").textContent = "Broken connection to image streamer";
				clearTimeout(getcntr);
				clearTimeout(wdTmout);
				wdTmout = setTimeout(TryImsock, 1000);
			}
		} catch(exception) {
			alert('Error' + exception);
		}
		clearTimeout(wdTmout);
		wdTmout = setTimeout(TryImsock, 3000);
	}
	function TryConnect(){
		if(connected) return;
		if(socket) delete socket;
		apprURL = get_appropriate_ws_url();
		if (typeof MozWebSocket != "undefined") {
			socket = new MozWebSocket(apprURL,
						"XY-protocol");
		} else {
			socket = new WebSocket(apprURL,
						"XY-protocol");
		}
		TryImsock();
		if(!socket || !imsocket){
			alert("Error: can't create websocket!\nMake sure that your browser supports websockets");
			return;
		}
		try {
			socket.onopen = function(){
				$("connected").style.backgroundColor = "#40ff40";
				$("connected").textContent = "Connection opened";
				connected = 1;
				socket.send("G"); // get speed
			}
			socket.onmessage = function(msg){
				var answ =  msg.data
				//console.log("socket get: " + answ);
				if(answ.substring(0,7) == "curspd="){ // server sent current motors' speed
					globSpeed = Number(answ.substring(7));
					$("speed").value = globSpeed;
					$("curspeed").textContent = globSpeed;
				}else
					$("answer").textContent = answ;
			}
			socket.onclose = function(){
				$("connected").style.backgroundColor = "#ff4040";
				$("connected").textContent = "Connection closed";
				$("answer").textContent = "";
				connected = 0;
				setTimeout(TryConnect, 1000);
			}
		} catch(exception) {
			alert('Error' + exception);
		}
	}
	function init(){
		console.log("init");
		$("cont").style.width = $("tab").clientWidth;
		var Buttons = document.getElementsByTagName("button");
		for(var i = 0; i < Buttons.length; i++){
			//Buttons[i].addEventListener("click", btnclick);
			Buttons[i].addEventListener("mousedown", btnmousedown);
			Buttons[i].addEventListener("mouseup", btnmouseup);
			Buttons[i].addEventListener("mouseout", btnmouseup);
			Buttons[i].pressed = 0;
		}
		$("speed").value = globSpeed;
		$("speed").addEventListener("input", ChSpd);
		$("speed").addEventListener("change", SetSpd);
		//var btn = document.createElement("button");
		//btn.onclick = Global.send;
		//document.body.appendChild(btn);
		//$("speed").onchange = SetSpd;
		TryConnect();
	}
	/*function btnclick(){
		console.log("Click: " + this.id);
	}*/
	function btnmouseup(){
		if(this.pressed == 0) return; // this function calls also from "mouseout", so we must prevent stopping twice
		this.pressed = 0;
		//console.log("Mouse up: " + this.id);
		if(connected) socket.send("U"+this.id);
	}
	function btnmousedown(){
		this.pressed = 1;
		//console.log("Mouse down: " + this.id);
		if(connected) socket.send("D"+this.id);
	}
	function ChSpd(){
		if(globSpeed == this.value) return;
		globSpeed = this.value;
		$("curspeed").textContent = globSpeed;
		$("answer").textContent = "";
	}
	function SetSpd(){
		if(connected) socket.send("S"+globSpeed);
	}
	return{
		init: init,
		send: send
	}
}();
</script>
</head>
<body onload="Global.init()">
	<table class="content"><tr><td valign="top">
	<div style="height: 1.5em;"></div>
	<div class="container" id="cont">
	<table class="content" id="tab">
		<tr><td></td>
			<td align='center'><button id='Y+'>Y+</button></td>
		<td></td></tr>
		<tr>
			<td align='center'><button id='X-'>X-</button></td>
			<td><button id='0'>0</button></td>
			<td align='center'><button id='X+'>X+</button></td>
		</tr>
		<tr><td></td>
			<td align='center'><button id='Y-'>Y-</button></td>
		<td></td></tr>
	</table>
	<div class="content">
		Speed: <input type="range" min="1" max="499" step="1" id="speed">
		<span id="curspeed">000</span>
	</div>
	<p></p>
	<div id = "connected">No connection</div>
	<div style="height: 1.5em;"><span id = "answer"></span></div>
	</div>
	</td><td>
	<div id="cntr" style="height: 1.5em;"></div>
	<div><img id="ws_image"></div></td></tr>
	</table>
</body>
</html>
